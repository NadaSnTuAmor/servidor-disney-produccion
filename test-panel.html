<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Panel de Pruebas - Sistema Disney+ Vigilancia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #00d4ff;
            transition: all 0.3s ease;
        }
        
        .test-section:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #00d4ff;
            font-size: 14px;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }
        
        button {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px 5px 5px 0;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
            background: linear-gradient(45deg, #00e6ff, #00b3e6);
        }
        
        .btn-test {
            background: linear-gradient(45deg, #ff6b00, #ff8c00) !important;
        }
        
        .btn-test:hover {
            background: linear-gradient(45deg, #ff7700, #ff9900) !important;
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000) !important;
        }
        
        .btn-danger:hover {
            background: linear-gradient(45deg, #ff5555, #dd0000) !important;
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #44ff44, #00cc00) !important;
        }
        
        .btn-success:hover {
            background: linear-gradient(45deg, #55ff55, #00dd00) !important;
            box-shadow: 0 8px 25px rgba(68, 255, 68, 0.4);
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff0000;
            color: #ff6666;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.1);
        }
        
        .warning {
            background: rgba(255, 165, 0, 0.1);
            border: 2px solid #ffa500;
            color: #ffcc66;
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.1);
        }
        
        .step-number {
            display: inline-block;
            background: #00d4ff;
            color: #1a1a2e;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .credentials-hint {
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.1);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-online {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .status-offline {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
            border: 1px solid #ff6666;
        }

        /* ESTILOS PARA LOS CORREOS EXPANDIBLES */
        .email-container {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 212, 255, 0.3);
        }

        .email-body {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }

        .btn-email {
            background: #00d4ff;
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-email.active {
            background: #ff6b00;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Panel de Pruebas Sistema Disney+</h1>
            <p>Prueba completa: Login â†’ BÃºsqueda â†’ Vigilancia â†’ Notificaciones</p>
        </div>

        <!-- PASO 1: LOGIN -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">1</span>
                <span>ğŸšª LOGIN AL SISTEMA</span>
                <span class="status-badge status-offline" id="loginStatus">Desconectado</span>
            </div>
            
            <div class="credentials-hint">
                ğŸ’¡ <strong>Credenciales de prueba disponibles:</strong><br>
                Usuario: USUARIO_MARIO | ContraseÃ±a: CLAVE1<br>
                Usuario: USUARIO2 | ContraseÃ±a: CLAVE2<br>
                Usuario: USUARIO_CARMEN | ContraseÃ±a: CARMEN123
            </div>
            
            <div class="form-group">
                <label for="loginUsername">Usuario:</label>
                <input type="text" id="loginUsername" placeholder="USUARIO_MARIO" value="USUARIO_MARIO">
            </div>
            <div class="form-group">
                <label for="loginPassword">ContraseÃ±a:</label>
                <input type="password" id="loginPassword" placeholder="CLAVE1" value="CLAVE1">
            </div>
            <button onclick="testLogin()">ğŸ” INICIAR SESIÃ“N</button>
            <button onclick="testDirectAccess()" class="btn-test">ğŸš€ ACCESO DIRECTO</button>
            <div id="loginResult"></div>
        </div>

        <!-- PASO 2: BUSCAR CORREO + VIGILANCIA -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">2</span>
                <span>ğŸ” BUSCAR CORREO + VIGILANCIA</span>
            </div>
            
            <div class="form-group">
                <label for="searchEmail">Email a vigilar:</label>
                <input type="text" id="searchEmail" placeholder="correo@gmail.com" value="gx03shop+c18ar@gmail.com">
            </div>
            <button onclick="testSearchEmail()">ğŸ¯ BUSCAR + ACTIVAR VIGILANCIA</button>
            <button onclick="clearSearchResults()" class="btn-test">ğŸ§¹ LIMPIAR RESULTADOS</button>
            <div id="searchResult"></div>
        </div>

        <!-- PASO 3: ESTADO DE VIGILANCIA -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">3</span>
                <span>ğŸ‘ï¸ ESTADO DE VIGILANCIA</span>
            </div>
            
            <button onclick="testWatchlist()">ğŸ‘ï¸ VER VIGILANCIA ACTIVA</button>
            <button onclick="refreshWatchlist()" class="btn-success">ğŸ”„ ACTUALIZAR ESTADO</button>
            <div id="watchlistResult"></div>
        </div>

        <!-- PASO 4: PRUEBAS DE NOTIFICACIONES -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">4</span>
                <span>ğŸ“± SISTEMA DE NOTIFICACIONES</span>
            </div>
            
            <button onclick="testTelegram()">ğŸ“± PROBAR TELEGRAM</button>
            <button onclick="testWhatsApp()">ğŸ“ PROBAR WHATSAPP</button>
            <button onclick="testDualAlert()">ğŸš¨ PROBAR ALERTA DUAL</button>
            <button onclick="clearNotificationResults()" class="btn-test">ğŸ§¹ LIMPIAR</button>
            <div id="notificationResult"></div>
        </div>

        <!-- PASO 5: HERRAMIENTAS ADICIONALES -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">5</span>
                <span>ğŸ› ï¸ HERRAMIENTAS ADICIONALES</span>
            </div>
            
            <button onclick="testDatabaseConnection()">ğŸ—„ï¸ PROBAR BASE DE DATOS</button>
            <button onclick="getServerStatus()">âš¡ ESTADO DEL SERVIDOR</button>
            <button onclick="clearAllResults()" class="btn-danger">ğŸ§¹ LIMPIAR TODO</button>
            <div id="toolsResult"></div>
        </div>
    </div>

    <script>
        // âœ… URL CORREGIDA - RENDER
        const API_BASE = 'https://servidor-disney-produccion.onrender.com';
        let authToken = '';

        console.log('ğŸš€ Panel inicializado');
        console.log('ğŸ“¡ API Base:', API_BASE);
        console.log('ğŸ”§ Sistema listo para pruebas');

        // FUNCIONES DE UTILIDAD
        function showResult(element, message, type) {
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateLoginStatus(connected) {
            const badge = document.getElementById('loginStatus');
            if (connected) {
                badge.textContent = 'Conectado';
                badge.className = 'status-badge status-online';
            } else {
                badge.textContent = 'Desconectado';
                badge.className = 'status-badge status-offline';
            }
        }

        // âœ… FUNCIÃ“N PARA MOSTRAR/OCULTAR CONTENIDO DEL CORREO
        function toggleEmailContent(emailId) {
            const content = document.getElementById(emailId);
            const button = event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'ğŸ™ˆ OCULTAR CONTENIDO';
                button.className = 'btn-email active';
            } else {
                content.style.display = 'none';
                button.textContent = 'ğŸ‘ï¸ VER CONTENIDO';
                button.className = 'btn-email';
            }
        }

        // PASO 1: LOGIN
        async function testLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const result = document.getElementById('loginResult');
            
            if (!username || !password) {
                showResult(result, 'Por favor completa todos los campos', 'error');
                return;
            }

            try {
                showResult(result, 'ğŸ”„ Conectando al servidor Render...', 'warning');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username, password: password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.token;
                    updateLoginStatus(true);
                    
                    showResult(result, `âœ… LOGIN EXITOSO! 

ğŸ‘¤ Usuario: ${data.user.username}
ğŸ†” ID: ${data.user.id}
ğŸ”‘ Token obtenido y vÃ¡lido
ğŸ“§ Emails asociados: ${data.user.emails?.length || 0}
ğŸ›¡ï¸ Estado seguridad: ${data.user.seguridad}
â° Expira en: ${data.expires_in}
ğŸ”’ Tipo: ${data.token_type}
ğŸ—„ï¸ Base de datos: ${data.database}

ğŸ¯ Ya puedes usar las funciones protegidas del sistema`, 'success');
                } else {
                    updateLoginStatus(false);
                    showResult(result, `âŒ ERROR LOGIN: ${data.message}

ğŸ’¡ Verifica:
- Usuario y contraseÃ±a correctos
- Usuario no estÃ© bloqueado
- ConexiÃ³n a base de datos funcionando`, 'error');
                }
            } catch (error) {
                updateLoginStatus(false);
                showResult(result, `âŒ ERROR DE CONEXIÃ“N: ${error.message}

ğŸ”§ Verificar:
- Servidor Render funcionando
- ConexiÃ³n a internet estable
- URL correcta: ${API_BASE}

ğŸ†˜ Si persiste, el servidor puede estar iniciÃ¡ndose (espera 1-2 minutos)`, 'error');
            }
        }

        // FUNCIÃ“N ACCESO DIRECTO
        function testDirectAccess() {
            const result = document.getElementById('loginResult');
            authToken = 'test-token-simulado-' + Date.now();
            updateLoginStatus(true);
            
            showResult(result, `ğŸš€ ACCESO DIRECTO ACTIVADO

âš ï¸ Token simulado para pruebas
ğŸ”‘ Token: ${authToken.substring(0, 30)}...
âœ… Puedes proceder con funciones bÃ¡sicas

ğŸ“ Nota: Algunas funciones protegidas pueden fallar
ğŸ’¡ Para funcionalidad completa, usa login real`, 'warning');
        }

        // PASO 2: BUSCAR CORREO + VIGILANCIA CON CORREOS EXPANDIBLES
        async function testSearchEmail() {
            const email = document.getElementById('searchEmail').value;
            const result = document.getElementById('searchResult');
            
            if (!email) {
                showResult(result, 'âŒ Por favor ingresa un email vÃ¡lido', 'error');
                return;
            }

            if (!authToken) {
                showResult(result, 'âš ï¸ Debes hacer login primero para usar esta funciÃ³n', 'error');
                return;
            }

            try {
                showResult(result, `ğŸ”„ PROCESANDO...

ğŸ“§ Email: ${email}
ğŸ” Buscando correos Ãºltimas 24h
ğŸ¯ Activando vigilancia inteligente
â³ Conectando con Gmail API...`, 'warning');
                
                const response = await fetch(`${API_BASE}/buscar-correos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ email_busqueda: email })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    showResult(result, `âŒ ERROR ${response.status}: ${errorData}`, 'error');
                    return;
                }

                const data = await response.json();
                
                if (response.ok) {
                    // âœ… GENERAR HTML INTERACTIVO PARA LOS CORREOS
                    let resultHTML = `<div class="result success">âœ… BÃšSQUEDA COMPLETADA + VIGILANCIA ACTIVADA

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š RESULTADOS DE BÃšSQUEDA:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“§ Email buscado: ${data.email_buscado}
ğŸ“Š Correos encontrados: ${data.total}
ğŸ‘¤ BÃºsqueda realizada por: ${data.searched_by}
ğŸ“® Gmail API conectado a: ${data.correo_principal_leido}
ğŸ“… PerÃ­odo: Ãšltimas 24 horas

`;

                    // Mostrar correos encontrados con HTML interactivo
                    if (data.emails && data.emails.length > 0) {
                        resultHTML += `ğŸ“‹ CORREOS ENCONTRADOS (${data.total}):

`;
                        
                        // Crear HTML para cada correo
                        data.emails.forEach((email, i) => {
                            const emailId = `email-${i}`;
                            const emailBody = email.body || 'Sin contenido disponible';
                            const isDisney = email.subject.includes('MyDisney') || emailBody.includes('Disney');
                            
                            resultHTML += `
<div class="email-container" style="${isDisney ? 'border-color: #ff6b00; background: rgba(255, 107, 0, 0.1);' : ''}">
    <div class="email-header">
        <div>
            <strong>ğŸ“§ ${email.subject}</strong> ${isDisney ? 'ğŸ¯' : ''}<br>
            ğŸ“¤ De: ${email.from}<br>
            ğŸ“… Fecha: ${email.date}
        </div>
        <button class="btn-email" onclick="toggleEmailContent('${emailId}')">
            ğŸ‘ï¸ VER CONTENIDO
        </button>
    </div>
    
    <div id="${emailId}" class="email-content" style="display: none;">
        <div class="email-body">
            <strong>ğŸ“– CONTENIDO COMPLETO:</strong><br><br>
            ${emailBody.replace(/\n/g, '<br>')}
        </div>
        
        <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
            <strong>ğŸ“ Vista previa:</strong> ${email.preview}<br>
            <strong>ğŸ†” ID:</strong> ${email.id}
        </div>
        
        ${isDisney ? '<div style="color: #ff6b00; font-weight: bold; margin-top: 10px;">ğŸš¨ Â¡POSIBLE CORREO DISNEY+!</div>' : ''}
    </div>
</div>`;
                        });
                    } else {
                        resultHTML += `ğŸ“­ NO SE ENCONTRARON CORREOS
â“ Posibles razones:
   â€¢ El email no recibiÃ³ correos en 24h
   â€¢ Email no existe en este Gmail
   â€¢ ConfiguraciÃ³n Gmail API incorrecta

`;
                    }

                    resultHTML += `

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ VIGILANCIA INTELIGENTE DISNEY+:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš¡ ESTADO: ACTIVA Y FUNCIONANDO
â° DuraciÃ³n total: 15 minutos
ğŸ” Sistema: 5 Revisiones aleatorias
ğŸ² Intervalos: Minuto 2-3, 5-6, 8-9, 11-12, 14-15

ğŸ” Busca: "Correo electr=C3=B3nico de MyDisney actua="
ğŸš¨ Si detecta cÃ³digo Disney+: BLOQUEO AUTOMÃTICO
ğŸ“± Notificaciones: Telegram + WhatsApp duales

âš ï¸ SISTEMA EN VIGILANCIA ACTIVA AHORA</div>`;

                    result.innerHTML = resultHTML;
                }
            } catch (error) {
                showResult(result, `âŒ ERROR DE CONEXIÃ“N: ${error.message}`, 'error');
            }
        }

        function clearSearchResults() {
            document.getElementById('searchResult').innerHTML = '';
        }

        // PASO 3: VIGILANCIA ACTIVA
        async function testWatchlist() {
            const result = document.getElementById('watchlistResult');
            
            if (!authToken) {
                showResult(result, 'âš ï¸ Debes hacer login primero', 'error');
                return;
            }

            try {
                showResult(result, 'ğŸ”„ Consultando sistema de vigilancia...', 'warning');
                
                const response = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    let watchInfo = `ğŸ‘ï¸ SISTEMA DE VIGILANCIA DISNEY+ - ESTADO ACTUAL

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š RESUMEN GENERAL:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ Vigilancias activas: ${data.total || 0}
ğŸ“ Revisiones por email: 5 revisiones aleatorias
â° DuraciÃ³n mÃ¡xima: 15 minutos
ğŸ”§ Sistema: Inteligente con timing impredecible

`;

                    if (data.activeWatches && data.activeWatches.length > 0) {
                        watchInfo += `ğŸ“‹ EMAILS BAJO VIGILANCIA ACTIVA:

`;
                        data.activeWatches.forEach((watch, i) => {
                            const elapsedMin = Math.floor(watch.elapsed / 60000);
                            const elapsedSec = Math.floor((watch.elapsed % 60000) / 1000);
                            const remainingMin = Math.floor(watch.remainingTime / 60000);
                            const remainingSec = Math.floor((watch.remainingTime % 60000) / 1000);
                            
                            watchInfo += `ã€ ${i+1} ã€‘â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“§ Email: ${watch.email}
âš¡ Estado: ${watch.status}
â° Tiempo transcurrido: ${elapsedMin}m ${elapsedSec}s
â³ Tiempo restante: ${remainingMin}m ${remainingSec}s
ğŸ¯ Timers activos: ${watch.activeTimers}
ğŸ“… Iniciado: ${new Date(watch.startTime).toLocaleString()}

`;
                        });
                    } else {
                        watchInfo += `ğŸ“­ NO HAY VIGILANCIAS ACTIVAS

ğŸ’¡ Para activar vigilancia:
   1. Hacer login
   2. Ir a "Buscar Correo + Vigilancia" 
   3. Ingresar email a vigilar
   4. Presionar "Buscar + Activar Vigilancia"

`;
                    }

                    showResult(result, watchInfo, 'success');
                } else {
                    showResult(result, `âŒ ERROR: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult(result, `âŒ ERROR DE CONEXIÃ“N: ${error.message}`, 'error');
            }
        }

        function refreshWatchlist() {
            testWatchlist();
        }

        // PASO 4: NOTIFICACIONES
        async function testTelegram() {
            const result = document.getElementById('notificationResult');
            try {
                showResult(result, 'ğŸ”„ Probando notificaciÃ³n Telegram...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        mensaje: `ğŸ§ª PRUEBA TELEGRAM - Panel Disney+
                        
â° Fecha: ${new Date().toLocaleString()}
ğŸ”§ Origen: Panel de Pruebas
âœ… Estado: Sistema funcionando correctamente
ğŸ›¡ï¸ Seguridad: Activa`
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `âœ… TELEGRAM FUNCIONANDO PERFECTAMENTE

ğŸ“± Mensaje enviado exitosamente
ğŸ¯ Canal: Admin principal
â° Enviado: ${new Date().toLocaleString()}
ğŸ”§ Estado: ConexiÃ³n estable`, 'success');
                } else {
                    showResult(result, `âŒ ERROR TELEGRAM: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult(result, `âŒ ERROR: ${error.message}`, 'error');
            }
        }

        async function testWhatsApp() {
            const result = document.getElementById('notificationResult');
            try {
                showResult(result, 'ğŸ”„ Probando notificaciÃ³n WhatsApp...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-whatsapp-simple`, {
                    method: 'GET'
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `âœ… WHATSAPP FUNCIONANDO PERFECTAMENTE

ğŸ“ Mensaje enviado a: ${data.numeroDestino}
ğŸŒ API: GREEN-API activa
â° Enviado: ${new Date().toLocaleString()}
ğŸ”§ Estado: ConexiÃ³n estable`, 'success');
                } else {
                    showResult(result, `âŒ ERROR WHATSAPP: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(result, `âŒ ERROR: ${error.message}`, 'error');
            }
        }

        async function testDualAlert() {
            const result = document.getElementById('notificationResult');
            try {
                showResult(result, 'ğŸ”„ Probando sistema de alertas duales...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-dual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        mensaje: `ğŸš¨ PRUEBA ALERTA DUAL - Sistema Disney+
                        
â° Fecha: ${new Date().toLocaleString()}
ğŸ”§ Origen: Panel de Pruebas
âœ… Estado: Alertas duales funcionando
ğŸ“± Canales: Telegram + WhatsApp
ğŸ›¡ï¸ Seguridad: Activa en ambos canales`,
                        numeroWhatsApp: '51935121273'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `âœ… SISTEMA DUAL FUNCIONANDO PERFECTAMENTE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š RESUMEN DE ENVÃO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“± Telegram â†’ ${data.destinatarios?.telegram || 'Admin'}
ğŸ“ WhatsApp Admin â†’ ${data.destinatarios?.admin || 'Enviado'}  
ğŸ‘¤ WhatsApp Cliente â†’ ${data.destinatarios?.cliente || 'Enviado'}

ğŸ¯ Sistema: Alertas duales activas
â° Enviado: ${new Date().toLocaleString()}
ğŸ”§ Estado: Ambos canales funcionando`, 'success');
                } else {
                    showResult(result, `âŒ ERROR ALERTA DUAL: ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                showResult(result, `âŒ ERROR: ${error.message}`, 'error');
            }
        }

        function clearNotificationResults() {
            document.getElementById('notificationResult').innerHTML = '';
        }

        // PASO 5: HERRAMIENTAS ADICIONALES
        async function testDatabaseConnection() {
            const result = document.getElementById('toolsResult');
            try {
                showResult(result, 'ğŸ”„ Probando conexiÃ³n a base de datos...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-db`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `âœ… BASE DE DATOS FUNCIONANDO

ğŸ—„ï¸ Supabase PostgreSQL conectada
â° Hora DB: ${data.database_time}
ğŸ”§ VersiÃ³n: ${data.postgres_version}
ğŸ“¡ Timestamp: ${data.timestamp}
âœ… Estado: ${data.message}`, 'success');
                } else {
                    showResult(result, `âŒ ERROR BD: ${data.message}
                    
CÃ³digo: ${data.error}
Timestamp: ${data.timestamp}`, 'error');
                }
            } catch (error) {
                showResult(result, `âŒ ERROR: ${error.message}`, 'error');
            }
        }

        async function getServerStatus() {
            const result = document.getElementById('toolsResult');
            try {
                showResult(result, 'ğŸ”„ Obteniendo estado del servidor...', 'warning');
                
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                
                if (response.ok) {
                    let statusInfo = `âš¡ SERVIDOR FUNCIONANDO CORRECTAMENTE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š INFORMACIÃ“N DEL SISTEMA:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ VersiÃ³n: ${data.version}
ğŸ›¡ï¸ Seguridad: ${data.security}
â° Timestamp: ${data.timestamp}
ğŸ’¬ Estado: ${data.message}

ğŸ¯ VIGILANCIA:
   â€¢ Tipo: ${data.vigilancia?.tipo || 'Inteligente'}
   â€¢ Revisiones: ${data.vigilancia?.revisiones || '5 aleatorias'}
   â€¢ DuraciÃ³n: ${data.vigilancia?.duracion || '15 minutos'}
   â€¢ Aleatorio: ${data.vigilancia?.aleatorio || 'SÃ­'}

ğŸ” JWT:
   â€¢ ExpiraciÃ³n: ${data.jwt_config?.expiration || '20 minutos'}
   â€¢ Auto-renovaciÃ³n: ${data.jwt_config?.sliding || 'Activa'}
   â€¢ Algoritmo: ${data.jwt_config?.algorithm || 'HS256'}

ğŸ“‹ ENDPOINTS DISPONIBLES:
`;
                    
                    if (data.endpoints) {
                        data.endpoints.forEach(endpoint => {
                            statusInfo += `   â€¢ ${endpoint}\n`;
                        });
                    }

                    showResult(result, statusInfo, 'success');
                } else {
                    showResult(result, `âŒ ERROR: No se pudo obtener estado`, 'error');
                }
            } catch (error) {
                showResult(result, `âŒ ERROR: ${error.message}`, 'error');
            }
        }

        function clearAllResults() {
            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('searchResult').innerHTML = '';
            document.getElementById('watchlistResult').innerHTML = '';
            document.getElementById('notificationResult').innerHTML = '';
            document.getElementById('toolsResult').innerHTML = '';
            updateLoginStatus(false);
            authToken = '';
            
            // Reset form values
            document.getElementById('loginUsername').value = 'USUARIO_MARIO';
            document.getElementById('loginPassword').value = 'CLAVE1';
            document.getElementById('searchEmail').value = 'gx03shop+c18ar@gmail.com';
        }

        // Auto-focus y configuraciÃ³n inicial
        window.onload = function() {
            document.getElementById('loginUsername').focus();
            console.log('ğŸš€ Panel de Pruebas Disney+ cargado');
            console.log('ğŸ“¡ API Base:', API_BASE);
            console.log('ğŸ”§ Sistema listo para pruebas');
        };

        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('âŒ Error global:', e.error);
        });
    </script>
</body>
</html>
