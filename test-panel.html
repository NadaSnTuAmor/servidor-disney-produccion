<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Panel de Pruebas - Sistema Disney+ Vigilancia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #00d4ff;
            transition: all 0.3s ease;
        }
        
        .test-section:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #00d4ff;
            font-size: 14px;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }
        
        button {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px 5px 5px 0;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
            background: linear-gradient(45deg, #00e6ff, #00b3e6);
        }
        
        .btn-test {
            background: linear-gradient(45deg, #ff6b00, #ff8c00) !important;
        }
        
        .btn-test:hover {
            background: linear-gradient(45deg, #ff7700, #ff9900) !important;
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000) !important;
        }
        
        .btn-danger:hover {
            background: linear-gradient(45deg, #ff5555, #dd0000) !important;
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #44ff44, #00cc00) !important;
        }
        
        .btn-success:hover {
            background: linear-gradient(45deg, #55ff55, #00dd00) !important;
            box-shadow: 0 8px 25px rgba(68, 255, 68, 0.4);
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff0000;
            color: #ff6666;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.1);
        }
        
        .warning {
            background: rgba(255, 165, 0, 0.1);
            border: 2px solid #ffa500;
            color: #ffcc66;
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.1);
        }
        
        .step-number {
            display: inline-block;
            background: #00d4ff;
            color: #1a1a2e;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .credentials-hint {
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.1);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-online {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .status-offline {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
            border: 1px solid #ff6666;
        }

        /* ESTILOS PARA LOS CORREOS EXPANDIBLES */
        .email-container {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 212, 255, 0.3);
        }

        .email-body {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }

        .btn-email {
            background: #00d4ff;
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-email.active {
            background: #ff6b00;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Panel de Pruebas Sistema Disney+</h1>
            <p>Prueba completa: Login ‚Üí B√∫squeda ‚Üí Vigilancia ‚Üí Notificaciones</p>
        </div>

        <!-- PASO 1: LOGIN -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">1</span>
                <span>üö™ LOGIN AL SISTEMA</span>
                <span class="status-badge status-offline" id="loginStatus">Desconectado</span>
            </div>
            
            <div class="credentials-hint">
                üí° <strong>Credenciales de prueba disponibles:</strong><br>
                Usuario: USUARIO_MARIO | Contrase√±a: CLAVE1<br>
                Usuario: USUARIO2 | Contrase√±a: CLAVE2<br>
                Usuario: USUARIO_CARMEN | Contrase√±a: CARMEN123
            </div>
            
            <div class="form-group">
                <label for="loginUsername">Usuario:</label>
                <input type="text" id="loginUsername" placeholder="USUARIO_MARIO" value="USUARIO_MARIO">
            </div>
            <div class="form-group">
                <label for="loginPassword">Contrase√±a:</label>
                <input type="password" id="loginPassword" placeholder="CLAVE1" value="CLAVE1">
            </div>
            <button onclick="testLogin()">üîê INICIAR SESI√ìN</button>
            <button onclick="testDirectAccess()" class="btn-test">üöÄ ACCESO DIRECTO</button>
            <div id="loginResult"></div>
        </div>

        <!-- PASO 2: BUSCAR CORREO + VIGILANCIA -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">2</span>
                <span>üîç BUSCAR CORREO + VIGILANCIA</span>
            </div>
            
            <div class="form-group">
                <label for="searchEmail">Email a vigilar:</label>
                <input type="text" id="searchEmail" placeholder="correo@gmail.com" value="gx03shop+c18ar@gmail.com">
            </div>
            <button onclick="testSearchEmail()">üéØ BUSCAR + ACTIVAR VIGILANCIA</button>
            <button onclick="clearSearchResults()" class="btn-test">üßπ LIMPIAR RESULTADOS</button>
            <div id="searchResult"></div>
        </div>

        <!-- PASO 3: ESTADO DE VIGILANCIA -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">3</span>
                <span>üëÅÔ∏è ESTADO DE VIGILANCIA</span>
            </div>
            
            <button onclick="testWatchlist()">üëÅÔ∏è VER VIGILANCIA ACTIVA</button>
            <button onclick="refreshWatchlist()" class="btn-success">üîÑ ACTUALIZAR ESTADO</button>
            <div id="watchlistResult"></div>
        </div>

        <!-- PASO 4: PRUEBAS DE NOTIFICACIONES -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">4</span>
                <span>üì± SISTEMA DE NOTIFICACIONES</span>
            </div>
            
            <button onclick="testTelegram()">üì± PROBAR TELEGRAM</button>
            <button onclick="testWhatsApp()">üìû PROBAR WHATSAPP</button>
            <button onclick="testDualAlert()">üö® PROBAR ALERTA DUAL</button>
            <button onclick="clearNotificationResults()" class="btn-test">üßπ LIMPIAR</button>
            <div id="notificationResult"></div>
        </div>

        <!-- PASO 5: HERRAMIENTAS ADICIONALES -->
        <div class="test-section">
            <div class="section-title">
                <span class="step-number">5</span>
                <span>üõ†Ô∏è HERRAMIENTAS ADICIONALES</span>
            </div>
            
            <button onclick="testDatabaseConnection()">üóÑÔ∏è PROBAR BASE DE DATOS</button>
            <button onclick="getServerStatus()">‚ö° ESTADO DEL SERVIDOR</button>
            <button onclick="clearAllResults()" class="btn-danger">üßπ LIMPIAR TODO</button>
            <div id="toolsResult"></div>
        </div>
    </div>

    <script>
        // ‚úÖ URL CORREGIDA - RENDER
        const API_BASE = 'https://servidor-disney-produccion.onrender.com';
        let authToken = '';

        console.log('üöÄ Panel inicializado');
        console.log('üì° API Base:', API_BASE);
        console.log('üîß Sistema listo para pruebas');

        // FUNCIONES DE UTILIDAD
        function showResult(element, message, type) {
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateLoginStatus(connected) {
            const badge = document.getElementById('loginStatus');
            if (connected) {
                badge.textContent = 'Conectado';
                badge.className = 'status-badge status-online';
            } else {
                badge.textContent = 'Desconectado';
                badge.className = 'status-badge status-offline';
            }
        }

        // ‚úÖ FUNCI√ìN PARA MOSTRAR/OCULTAR CONTENIDO DEL CORREO
        function toggleEmailContent(emailId) {
            const content = document.getElementById(emailId);
            const button = event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'üôà OCULTAR CONTENIDO';
                button.className = 'btn-email active';
            } else {
                content.style.display = 'none';
                button.textContent = 'üëÅÔ∏è VER CONTENIDO';
                button.className = 'btn-email';
            }
        }

        // PASO 1: LOGIN
        async function testLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const result = document.getElementById('loginResult');
            
            if (!username || !password) {
                showResult(result, 'Por favor completa todos los campos', 'error');
                return;
            }

            try {
                showResult(result, 'üîÑ Conectando al servidor Render...', 'warning');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username, password: password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.token;
                    updateLoginStatus(true);
                    
                    showResult(result, `‚úÖ LOGIN EXITOSO! 

üë§ Usuario: ${data.user.username}
üÜî ID: ${data.user.id}
üîë Token obtenido y v√°lido
üìß Emails asociados: ${data.user.emails?.length || 0}
üõ°Ô∏è Estado seguridad: ${data.user.seguridad}
‚è∞ Expira en: ${data.expires_in}
üîí Tipo: ${data.token_type}
üóÑÔ∏è Base de datos: ${data.database}

üéØ Ya puedes usar las funciones protegidas del sistema`, 'success');
                } else {
                    updateLoginStatus(false);
                    showResult(result, `‚ùå ERROR LOGIN: ${data.message}

üí° Verifica:
- Usuario y contrase√±a correctos
- Usuario no est√© bloqueado
- Conexi√≥n a base de datos funcionando`, 'error');
                }
            } catch (error) {
                updateLoginStatus(false);
                showResult(result, `‚ùå ERROR DE CONEXI√ìN: ${error.message}

üîß Verificar:
- Servidor Render funcionando
- Conexi√≥n a internet estable
- URL correcta: ${API_BASE}

üÜò Si persiste, el servidor puede estar inici√°ndose (espera 1-2 minutos)`, 'error');
            }
        }

        // FUNCI√ìN ACCESO DIRECTO
        function testDirectAccess() {
            const result = document.getElementById('loginResult');
            authToken = 'test-token-simulado-' + Date.now();
            updateLoginStatus(true);
            
            showResult(result, `üöÄ ACCESO DIRECTO ACTIVADO

‚ö†Ô∏è Token simulado para pruebas
üîë Token: ${authToken.substring(0, 30)}...
‚úÖ Puedes proceder con funciones b√°sicas

üìù Nota: Algunas funciones protegidas pueden fallar
üí° Para funcionalidad completa, usa login real`, 'warning');
        }

        // PASO 2: BUSCAR CORREO + VIGILANCIA CON CORREOS EXPANDIBLES
        async function testSearchEmail() {
            const email = document.getElementById('searchEmail').value;
            const result = document.getElementById('searchResult');
            
            if (!email) {
                showResult(result, '‚ùå Por favor ingresa un email v√°lido', 'error');
                return;
            }

            if (!authToken) {
                showResult(result, '‚ö†Ô∏è Debes hacer login primero para usar esta funci√≥n', 'error');
                return;
            }

            try {
                showResult(result, `üîÑ PROCESANDO...

üìß Email: ${email}
üîç Buscando correos √∫ltimas 24h
üéØ Activando vigilancia inteligente
‚è≥ Conectando con Gmail API...`, 'warning');
                
                const response = await fetch(`${API_BASE}/buscar-correos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ email_busqueda: email })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    showResult(result, `‚ùå ERROR ${response.status}: ${errorData}`, 'error');
                    return;
                }

                const data = await response.json();
                
                if (response.ok) {
                    // ‚úÖ GENERAR HTML INTERACTIVO PARA LOS CORREOS
                    let resultHTML = `<div class="result success">‚úÖ B√öSQUEDA COMPLETADA + VIGILANCIA ACTIVADA

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä RESULTADOS DE B√öSQUEDA:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìß Email buscado: ${data.email_buscado}
üìä Correos encontrados: ${data.total}
üë§ B√∫squeda realizada por: ${data.searched_by}
üìÆ Gmail API conectado a: ${data.correo_principal_leido}
üìÖ Per√≠odo: √öltimas 24 horas

`;

                    // Mostrar correos encontrados con HTML interactivo
                    if (data.emails && data.emails.length > 0) {
                        resultHTML += `üìã CORREOS ENCONTRADOS (${data.total}):

`;
                        
                        // Crear HTML para cada correo
                        data.emails.forEach((email, i) => {
                            const emailId = `email-${i}`;
                            const emailBody = email.body || 'Sin contenido disponible';
                            const isDisney = email.subject.includes('MyDisney') || emailBody.includes('Disney');
                            
                            resultHTML += `
<div class="email-container" style="${isDisney ? 'border-color: #ff6b00; background: rgba(255, 107, 0, 0.1);' : ''}">
    <div class="email-header">
        <div>
            <strong>üìß ${email.subject}</strong> ${isDisney ? 'üéØ' : ''}<br>
            üì§ De: ${email.from}<br>
            üìÖ Fecha: ${email.date}
        </div>
        <button class="btn-email" onclick="toggleEmailContent('${emailId}')">
            üëÅÔ∏è VER CONTENIDO
        </button>
    </div>
    
    <div id="${emailId}" class="email-content" style="display: none;">
        <div class="email-body">
            <strong>üìñ CONTENIDO COMPLETO:</strong><br><br>
            ${emailBody.replace(/\n/g, '<br>')}
        </div>
        
        <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
            <strong>üìù Vista previa:</strong> ${email.preview}<br>
            <strong>üÜî ID:</strong> ${email.id}
        </div>
        
        ${isDisney ? '<div style="color: #ff6b00; font-weight: bold; margin-top: 10px;">üö® ¬°POSIBLE CORREO DISNEY+!</div>' : ''}
    </div>
</div>`;
                        });
                    } else {
                        resultHTML += `üì≠ NO SE ENCONTRARON CORREOS
‚ùì Posibles razones:
   ‚Ä¢ El email no recibi√≥ correos en 24h
   ‚Ä¢ Email no existe en este Gmail
   ‚Ä¢ Configuraci√≥n Gmail API incorrecta

`;
                    }

                    resultHTML += `

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ VIGILANCIA INTELIGENTE DISNEY+:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö° ESTADO: ACTIVA Y FUNCIONANDO
‚è∞ Duraci√≥n total: 15 minutos
üîç Sistema: 5 Revisiones aleatorias
üé≤ Intervalos: Minuto 2-3, 5-6, 8-9, 11-12, 14-15

üîç Busca: "Correo electr=C3=B3nico de MyDisney actua="
üö® Si detecta c√≥digo Disney+: BLOQUEO AUTOM√ÅTICO
üì± Notificaciones: Telegram + WhatsApp duales

‚ö†Ô∏è SISTEMA EN VIGILANCIA ACTIVA AHORA</div>`;

                    result.innerHTML = resultHTML;
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR DE CONEXI√ìN: ${error.message}`, 'error');
            }
        }

        function clearSearchResults() {
            document.getElementById('searchResult').innerHTML = '';
        }

        // PASO 3: VIGILANCIA ACTIVA
        async function testWatchlist() {
            const result = document.getElementById('watchlistResult');
            
            if (!authToken) {
                showResult(result, '‚ö†Ô∏è Debes hacer login primero', 'error');
                return;
            }

            try {
                showResult(result, 'üîÑ Consultando sistema de vigilancia...', 'warning');
                
                const response = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    let watchInfo = `üëÅÔ∏è SISTEMA DE VIGILANCIA DISNEY+ - ESTADO ACTUAL

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä RESUMEN GENERAL:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéØ Vigilancias activas: ${data.total || 0}
üìù Revisiones por email: 5 revisiones aleatorias
‚è∞ Duraci√≥n m√°xima: 15 minutos
üîß Sistema: Inteligente con timing impredecible

`;

                    if (data.activeWatches && data.activeWatches.length > 0) {
                        watchInfo += `üìã EMAILS BAJO VIGILANCIA ACTIVA:

`;
                        data.activeWatches.forEach((watch, i) => {
                            const elapsedMin = Math.floor(watch.elapsed / 60000);
                            const elapsedSec = Math.floor((watch.elapsed % 60000) / 1000);
                            const remainingMin = Math.floor(watch.remainingTime / 60000);
                            const remainingSec = Math.floor((watch.remainingTime % 60000) / 1000);
                            
                            watchInfo += `„Äê ${i+1} „Äë‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìß Email: ${watch.email}
‚ö° Estado: ${watch.status}
‚è∞ Tiempo transcurrido: ${elapsedMin}m ${elapsedSec}s
‚è≥ Tiempo restante: ${remainingMin}m ${remainingSec}s
üéØ Timers activos: ${watch.activeTimers}
üìÖ Iniciado: ${new Date(watch.startTime).toLocaleString()}

`;
                        });
                    } else {
                        watchInfo += `üì≠ NO HAY VIGILANCIAS ACTIVAS

üí° Para activar vigilancia:
   1. Hacer login
   2. Ir a "Buscar Correo + Vigilancia" 
   3. Ingresar email a vigilar
   4. Presionar "Buscar + Activar Vigilancia"

`;
                    }

                    showResult(result, watchInfo, 'success');
                } else {
                    showResult(result, `‚ùå ERROR: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR DE CONEXI√ìN: ${error.message}`, 'error');
            }
        }

        function refreshWatchlist() {
            testWatchlist();
        }

        // PASO 4: NOTIFICACIONES
        async function testTelegram() {
            const result = document.getElementById('notificationResult');
            try {
                showResult(result, 'üîÑ Probando notificaci√≥n Telegram...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        mensaje: `üß™ PRUEBA TELEGRAM - Panel Disney+
                        
‚è∞ Fecha: ${new Date().toLocaleString()}
üîß Origen: Panel de Pruebas
‚úÖ Estado: Sistema funcionando correctamente
üõ°Ô∏è Seguridad: Activa`
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `‚úÖ TELEGRAM FUNCIONANDO PERFECTAMENTE

üì± Mensaje enviado exitosamente
üéØ Canal: Admin principal
‚è∞ Enviado: ${new Date().toLocaleString()}
üîß Estado: Conexi√≥n estable`, 'success');
                } else {
                    showResult(result, `‚ùå ERROR TELEGRAM: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        async function testWhatsApp() {
            const result = document.getElementById('notificationResult');
            try {
                showResult(result, 'üîÑ Probando notificaci√≥n WhatsApp...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-whatsapp-simple`, {
                    method: 'GET'
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `‚úÖ WHATSAPP FUNCIONANDO PERFECTAMENTE

üìû Mensaje enviado a: ${data.numeroDestino}
üåê API: GREEN-API activa
‚è∞ Enviado: ${new Date().toLocaleString()}
üîß Estado: Conexi√≥n estable`, 'success');
                } else {
                    showResult(result, `‚ùå ERROR WHATSAPP: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        async function testDualAlert() {
            const result = document.getElementById('notificationResult');
            try {
                showResult(result, 'üîÑ Probando sistema de alertas duales...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-dual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        mensaje: `üö® PRUEBA ALERTA DUAL - Sistema Disney+
                        
‚è∞ Fecha: ${new Date().toLocaleString()}
üîß Origen: Panel de Pruebas
‚úÖ Estado: Alertas duales funcionando
üì± Canales: Telegram + WhatsApp
üõ°Ô∏è Seguridad: Activa en ambos canales`,
                        numeroWhatsApp: '51935121273'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `‚úÖ SISTEMA DUAL FUNCIONANDO PERFECTAMENTE

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä RESUMEN DE ENV√çO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üì± Telegram ‚Üí ${data.destinatarios?.telegram || 'Admin'}
üìû WhatsApp Admin ‚Üí ${data.destinatarios?.admin || 'Enviado'}  
üë§ WhatsApp Cliente ‚Üí ${data.destinatarios?.cliente || 'Enviado'}

üéØ Sistema: Alertas duales activas
‚è∞ Enviado: ${new Date().toLocaleString()}
üîß Estado: Ambos canales funcionando`, 'success');
                } else {
                    showResult(result, `‚ùå ERROR ALERTA DUAL: ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        function clearNotificationResults() {
            document.getElementById('notificationResult').innerHTML = '';
        }

        // PASO 5: HERRAMIENTAS ADICIONALES
        async function testDatabaseConnection() {
            const result = document.getElementById('toolsResult');
            try {
                showResult(result, 'üîÑ Probando conexi√≥n a base de datos...', 'warning');
                
                const response = await fetch(`${API_BASE}/test-db`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(result, `‚úÖ BASE DE DATOS FUNCIONANDO

üóÑÔ∏è Supabase PostgreSQL conectada
‚è∞ Hora DB: ${data.database_time}
üîß Versi√≥n: ${data.postgres_version}
üì° Timestamp: ${data.timestamp}
‚úÖ Estado: ${data.message}`, 'success');
                } else {
                    showResult(result, `‚ùå ERROR BD: ${data.message}
                    
C√≥digo: ${data.error}
Timestamp: ${data.timestamp}`, 'error');
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        async function getServerStatus() {
            const result = document.getElementById('toolsResult');
            try {
                showResult(result, 'üîÑ Obteniendo estado del servidor...', 'warning');
                
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                
                if (response.ok) {
                    let statusInfo = `‚ö° SERVIDOR FUNCIONANDO CORRECTAMENTE

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä INFORMACI√ìN DEL SISTEMA:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üîß Versi√≥n: ${data.version}
üõ°Ô∏è Seguridad: ${data.security}
‚è∞ Timestamp: ${data.timestamp}
üí¨ Estado: ${data.message}

üéØ VIGILANCIA:
   ‚Ä¢ Tipo: ${data.vigilancia?.tipo || 'Inteligente'}
   ‚Ä¢ Revisiones: ${data.vigilancia?.revisiones || '5 aleatorias'}
   ‚Ä¢ Duraci√≥n: ${data.vigilancia?.duracion || '15 minutos'}
   ‚Ä¢ Aleatorio: ${data.vigilancia?.aleatorio || 'S√≠'}

üîê JWT:
   ‚Ä¢ Expiraci√≥n: ${data.jwt_config?.expiration || '20 minutos'}
   ‚Ä¢ Auto-renovaci√≥n: ${data.jwt_config?.sliding || 'Activa'}
   ‚Ä¢ Algoritmo: ${data.jwt_config?.algorithm || 'HS256'}

üìã ENDPOINTS DISPONIBLES:
`;
                    
                    if (data.endpoints) {
                        data.endpoints.forEach(endpoint => {
                            statusInfo += `   ‚Ä¢ ${endpoint}\n`;
                        });
                    }

                    showResult(result, statusInfo, 'success');
                } else {
                    showResult(result, `‚ùå ERROR: No se pudo obtener estado`, 'error');
                }
            } catch (error) {
                showResult(result, `‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        function clearAllResults() {
            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('searchResult').innerHTML = '';
            document.getElementById('watchlistResult').innerHTML = '';
            document.getElementById('notificationResult').innerHTML = '';
            document.getElementById('toolsResult').innerHTML = '';
            updateLoginStatus(false);
            authToken = '';
            
            // Reset form values
            document.getElementById('loginUsername').value = 'USUARIO_MARIO';
            document.getElementById('loginPassword').value = 'CLAVE1';
            document.getElementById('searchEmail').value = 'gx03shop+c18ar@gmail.com';
        }

        // Auto-focus y configuraci√≥n inicial
        window.onload = function() {
            document.getElementById('loginUsername').focus();
            console.log('üöÄ Panel de Pruebas Disney+ cargado');
            console.log('üì° API Base:', API_BASE);
            console.log('üîß Sistema listo para pruebas');
        };

        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('‚ùå Error global:', e.error);
        });
    </script>
</body>
</html>
